<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BD TM MINI BOT</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Monetag SDK (you already had this) -->
  <script src="//libtl.com/sdk.js" data-zone="9842278" data-sdk="show_9842278"></script>

  <style>
    /* Basic styles + lighting */
    :root{
      --glass: rgba(255,255,255,0.06);
      --accent1:#34d399; --accent2:#60a5fa; --accent3:#a78bfa; --accent4:#fb7185; --accent5:#f59e0b;
    }
    body{font-family: system-ui, "Noto Sans Bengali", Arial; background: linear-gradient(180deg,#071024,#120924); color:#fff; margin:0; padding-bottom:96px;}
    .container{max-width:480px;margin:0 auto;padding:16px;}
    .glass{background:var(--glass);backdrop-filter: blur(8px);border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .lighting{animation:glowColors 6s infinite}
    @keyframes glowColors{
      0%{color:var(--accent1); text-shadow:0 0 6px var(--accent1)}
      25%{color:var(--accent2); text-shadow:0 0 8px var(--accent2)}
      50%{color:var(--accent3); text-shadow:0 0 10px var(--accent3)}
      75%{color:var(--accent4); text-shadow:0 0 10px var(--accent4)}
      100%{color:var(--accent5); text-shadow:0 0 6px var(--accent5)}
    }

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:110px; background:linear-gradient(90deg,#10b981,#06b6d4);
      color:white; padding:10px 14px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.4); z-index:9999;
      opacity:0; transform:translateY(8px); transition:all .25s;
    }
    .toast.show{opacity:1; transform:translateY(0);}

    /* Bomb */
    .bomb{position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); font-size:3.2rem; z-index:9998; animation:bombAnim .9s ease-out forwards}
    @keyframes bombAnim{0%{opacity:1; transform:translate(-50%,-50%) scale(.6)} 60%{transform:translate(-50%,-60%) scale(1.6)} 100%{opacity:0; transform:translate(-50%,-120%) scale(2.6)}}

    /* Bottom nav */
    .bottom-nav{position:fixed; left:12px; right:12px; bottom:12px; display:flex; gap:8px; background:rgba(0,0,0,0.28); padding:8px; border-radius:14px; align-items:center; justify-content:space-between; backdrop-filter: blur(6px); z-index:50}
    .nav-btn{flex:1; text-align:center; padding:10px 6px; border-radius:12px; cursor:pointer; user-select:none}
    .nav-btn .icon{font-size:18px; display:block}
    .nav-btn.active{box-shadow:0 10px 30px rgba(124,58,237,0.18); transform:translateY(-4px);}

    /* Tabs */
    .tab{display:none}
    .tab.show{display:block; animation:fade .28s}
    @keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

    /* small table */
    table{width:100%; border-collapse:collapse}
    table th, table td{padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; font-size:13px}

    /* responsive */
    @media (max-width:420px){ .container{padding:12px} .nav-btn{padding:8px} }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header class="glass text-center mb-4">
      <h1 class="text-2xl font-bold lighting">BD TM MINI BOT</h1>
      <p class="text-sm mt-1">‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‚Äî ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ßß‡ß¶‡ß¶ ‡¶è‡¶°</p>
    </header>

    <!-- Join Tab (default view until joined) -->
    <section id="tab-join" class="tab show glass mb-4">
      <h2 class="font-bold text-lg">üì¢ ‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
      <p class="text-sm mt-2">‡¶¨‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶ó‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</p>
      <a id="joinLink" href="https://t.me/ADS_EARNING_BD_TM_CHANNEL" target="_blank"
         class="block mt-4 px-4 py-3 bg-green-500 rounded-lg text-center font-semibold">‚úÖ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
      <button id="confirmJoinBtn" class="block mt-3 px-4 py-3 bg-yellow-500 rounded-lg w-full font-semibold">‡¶Ü‡¶Æ‡¶ø ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø</button>
      <p class="text-xs mt-2 text-gray-300">‡¶®‡ßã‡¶ü: ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§</p>
    </section>

    <!-- HOME -->
    <section id="tab-home" class="tab glass mb-4">
      <div class="text-center">
        <div class="text-sm lighting">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
        <div id="ui-balance" class="text-3xl font-bold mt-2 lighting">0.00 ‡ß≥</div>
        <div class="mt-2 text-sm">‡¶Ü‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶è‡¶°: <span id="ui-ads-count">0</span> / 100</div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="goAdsBtn" class="w-1/2 px-3 py-2 bg-cyan-500 rounded-xl">‚ñ∂ ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
        <button id="goWithdrawBtn" class="w-1/2 px-3 py-2 bg-emerald-600 rounded-xl">üí≥ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</button>
      </div>
    </section>

    <!-- ADS -->
    <section id="tab-ads" class="tab glass mb-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold lighting">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</div>
        <div class="text-xs">Monetag ‡ßß‡ß´s (‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü) ‚Ä¢ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡ßß‡ß≠s ‡¶™‡¶∞‡ßá</div>
      </div>
      <div class="mt-6">
        <button id="btn-watch" class="w-full py-3 bg-blue-600 rounded-xl lighting">‚ñ∂ ‡¶è‡¶ñ‡¶®‡¶á ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
          <div class="text-xs mt-1">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶è‡¶°: <span id="ads-left">100</span></div>
        </button>
      </div>
      <div id="ad-countdown" class="mt-4 text-sm"></div>
    </section>

    <!-- WITHDRAW -->
    <section id="tab-withdraw" class="tab glass mb-4">
      <div class="font-semibold">üí≥ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü</div>
      <div class="text-xs mt-1">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂: ‡¶Æ‡¶ø‡¶® ‡ßß‡ß¶‡ß≥ ‚Ä¢ ‡¶®‡¶ó‡¶¶: ‡¶Æ‡¶ø‡¶® ‡ß´‡ß¶‡ß≥ ‚Ä¢ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú: ‡¶Æ‡¶ø‡¶® ‡ß®‡ß¶‡ß≥</div>

      <div class="mt-3">
        <select id="withdraw-method" class="w-full p-2 rounded text-black">
          <option value="bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
          <option value="nagad">‡¶®‡¶ó‡¶¶</option>
          <option value="recharge">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú</option>
        </select>
        <input id="withdraw-number" class="w-full p-2 mt-2 rounded" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (01XXXXXXXXX)" />
        <input id="withdraw-amount" type="number" class="w-full p-2 mt-2 rounded" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" />
        <button id="submit-withdraw" class="w-full mt-3 py-2 bg-emerald-600 rounded-lg">‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <p class="text-xs mt-2 text-gray-300">‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ñ‡¶æ‡¶®‡ßá Pending ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá</p>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="tab-account" class="tab glass mb-4">
      <div class="font-semibold">üë§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</div>
      <div class="mt-2 text-sm">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø: <span id="acc-id"></span></div>
      <div class="mt-1 text-sm">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: <span id="acc-balance"></span> ‡ß≥</div>
      <div class="mt-1 text-sm">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶è‡¶°: <span id="acc-ads-today"></span></div>
      <div class="mt-1 text-sm">‡¶Æ‡ßã‡¶ü ‡¶è‡¶° (‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï): <span id="acc-ads-total"></span></div>
      <div class="mt-3">
        <input id="refer-link" class="w-full p-2 rounded text-black" readonly value="https://t.me/BD_TM_MINI_BOT" />
        <button id="copy-refer" class="w-full mt-2 py-2 bg-pink-600 rounded-lg">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="tab glass mb-4">
      <div class="font-semibold lighting">‚öôÔ∏è ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</div>
      <div id="admin-login-area" class="mt-3">
        <input id="admin-pass" type="password" class="w-full p-2 rounded text-black" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®" />
        <button id="admin-login-btn" class="w-full mt-2 py-2 bg-yellow-500 rounded-lg">‡¶≤‡¶ó‡¶á‡¶®</button>
      </div>

      <div id="admin-area" class="hidden mt-4">
        <div class="mb-3">
          <div>üë• ‡¶Æ‡ßã‡¶ü ‡¶á‡¶â‡¶ú‡¶æ‡¶∞: <span id="admin-user-count">0</span></div>
          <div>‚ñ∂ ‡¶Æ‡ßã‡¶ü ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶æ: <span id="admin-total-ads">0</span></div>
          <div>üí∞ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: <span id="admin-total-balance">0.00</span> ‡ß≥</div>
        </div>

        <div class="mt-2">
          <div class="font-semibold">üìã ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
          <table class="mt-2">
            <thead><tr><th>ID</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</th><th>‡¶Ü‡¶ú‡¶ï‡ßá</th><th>‡¶Æ‡ßã‡¶ü</th></tr></thead>
            <tbody id="admin-users-tbody"></tbody>
          </table>
        </div>

        <div class="mt-4">
          <div class="font-semibold">üí≥ Pending Withdraw</div>
          <table class="mt-2">
            <thead><tr><th>ID</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞</th><th>‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</th><th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
            <tbody id="admin-withdraws-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div> <!-- container end -->

  <!-- bottom nav -->
  <div class="bottom-nav">
    <div id="nav-home" class="nav-btn active" onclick="navOpen('home')"><span class="icon">üè†</span><span class="label" style="font-size:12px">‡¶π‡ßã‡¶Æ</span></div>
    <div id="nav-ads" class="nav-btn" onclick="navOpen('ads')"><span class="icon">‚ñ∂</span><span class="label" style="font-size:12px">‡¶è‡¶°</span></div>
    <div id="nav-withdraw" class="nav-btn" onclick="navOpen('withdraw')"><span class="icon">üí≥</span><span class="label" style="font-size:12px">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</span></div>
    <div id="nav-account" class="nav-btn" onclick="navOpen('account')"><span class="icon">üë§</span><span class="label" style="font-size:12px">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span></div>
    <div id="nav-admin" class="nav-btn" onclick="navOpen('admin')"><span class="icon">‚öôÔ∏è</span><span class="label" style="font-size:12px">‡¶è‡¶°‡¶Æ‡¶ø‡¶®</span></div>
  </div>

  <!-- toast + bomb root -->
  <div id="toast-root" class="toast"></div>
  <div id="bomb-root"></div>

<script>
/* ========== CONFIG ========== */
/* Use the Bot Token and Admin Chat ID you provided earlier.
   NOTE: Browser -> Telegram API calls may be blocked by CORS in some browsers.
   If telegram messages don't go through, use a small server-side proxy (I can give code).
*/
const BOT_TOKEN = "8169503775:AAHFBx2dXbnXLZHje8MUzgsx5chWjxD9dKY";
const ADMIN_CHAT_ID = "7691157254";
const ADMIN_PASSWORD = "Sharif000";

const DAILY_LIMIT = 100;
const AD_REWARD = 0.20;
const AD_MONETAG_SECONDS = 15; // Monetag ad length (information)
const REWARD_SECONDS = 17;     // reward delivered after 17s

const STORAGE_KEY = "bdtm_state_v4";

/* ========== STATE ========== */
let state = {
  users: {},         // userId -> { id, balance, adsToday, adsTotal, lastAdDate }
  withdraws: [],     // { id, userId, method, number, amount, status, ts }
  currentUserId: null
};

/* ========== UTIL ========== */
function uid(){ return 'u' + Date.now().toString(36) + Math.floor(Math.random()*9000+1000).toString(36); }
function todayKey(){ return new Date().toISOString().slice(0,10); }

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){ try{ state = JSON.parse(raw); } catch(e){ console.warn(e); } }
  if(!state.currentUserId){
    const id = uid();
    state.currentUserId = id;
    state.users[id] = { id, balance:0, adsToday:0, adsTotal:0, lastAdDate: todayKey() };
    saveState();
  }
  // ensure each user has fields
  Object.values(state.users).forEach(u=>{
    if(typeof u.balance === 'undefined') u.balance = 0;
    if(typeof u.adsToday === 'undefined') u.adsToday = 0;
    if(typeof u.adsTotal === 'undefined') u.adsTotal = 0;
    if(!u.lastAdDate) u.lastAdDate = todayKey();
  });
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function currentUser(){ return state.users[state.currentUserId]; }

/* reset user's adsToday if date changed */
function ensureDailyResetForUser(u){
  const tk = todayKey();
  if(u.lastAdDate !== tk){
    u.adsToday = 0;
    u.lastAdDate = tk;
  }
}

/* ========== UI HELPERS ========== */
function showToast(msg, type="info", ms=3500){
  const root = document.getElementById('toast-root');
  root.innerText = msg;
  root.className = 'toast show';
  if(type === 'success') root.style.background = 'linear-gradient(90deg,#10b981,#06b6d4)';
  else if(type === 'error') root.style.background = 'linear-gradient(90deg,#ef4444,#f97316)';
  else root.style.background = 'linear-gradient(90deg,#2563eb,#06b6d4)';
  setTimeout(()=>{ root.className = 'toast'; }, ms);
}
function showBomb(){
  const r = document.getElementById('bomb-root');
  const el = document.createElement('div'); el.className = 'bomb'; el.innerText = 'üí£üí•';
  r.appendChild(el); setTimeout(()=>el.remove(), 900);
}

/* ========== NAV & JOIN CHECK ========== */
let joined_channel = (localStorage.getItem('bdtm_joined') === 'yes');

function setJoined(val){
  joined_channel = val;
  localStorage.setItem('bdtm_joined', val ? 'yes' : 'no');
}

/* open a tab by key (home, ads, withdraw, account, admin, join) */
function navOpen(key){
  // require join for everything except 'join'
  if(!joined_channel && key !== 'join'){
    showToast('‚ö†Ô∏è ‡¶Ü‡¶ó‡ßá ‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error');
    openTab('join'); return;
  }
  openTab(key);
}

function openTab(key){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('show'));
  const id = key === 'home' ? 'tab-home' : key === 'ads' ? 'tab-ads' : key === 'withdraw' ? 'tab-withdraw' : key === 'account' ? 'tab-account' : key === 'admin' ? 'tab-admin' : key === 'join' ? 'tab-join' : null;
  if(!id) return;
  document.getElementById(id).classList.add('show');
  // nav active styles
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const navId = key === 'home' ? 'nav-home' : key === 'ads' ? 'nav-ads' : key === 'withdraw' ? 'nav-withdraw' : key === 'account' ? 'nav-account' : key === 'admin' ? 'nav-admin' : null;
  if(navId) document.getElementById(navId).classList.add('active');

  // render dynamic if needed
  renderHome();
  if(key === 'account') renderAccount();
  if(key === 'admin') renderAdmin();
}

/* ========== INIT USER & RENDER ========== */
loadState();
ensureDailyResetForUser(currentUser());
saveState();

function renderHome(){
  const u = currentUser();
  ensureDailyResetForUser(u);
  document.getElementById('ui-balance').innerText = (u.balance||0).toFixed(2) + ' ‡ß≥';
  document.getElementById('ui-ads-count').innerText = (u.adsToday||0);
  document.getElementById('ads-left').innerText = Math.max(0, DAILY_LIMIT - (u.adsToday||0));
}

/* ========== AD FLOW ========== */
let adRunning = false;

function adsRemainingForUser(){
  const u = currentUser();
  ensureDailyResetForUser(u);
  return Math.max(0, DAILY_LIMIT - (u.adsToday||0));
}

document.getElementById('btn-watch').addEventListener('click', startAdFlow);
document.getElementById('goAdsBtn').addEventListener('click', ()=> navOpen('ads'));
document.getElementById('goWithdrawBtn').addEventListener('click', ()=> navOpen('withdraw'));

function startAdFlow(){
  const u = currentUser();
  ensureDailyResetForUser(u);
  if(adRunning) return;
  if(adsRemainingForUser() <= 0){ showToast('‚ö†Ô∏è ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ 100 ‡¶è‡¶° ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá', 'error'); return; }

  // Call Monetag - Monetag handles its own timing (15s)
  if(typeof show_9842278 === 'function'){
    try { show_9842278(); } catch(e){ console.warn('Monetag invocation error', e); }
  } else {
    // If SDK not present, we still simulate; Monetag popup may require live hosting
    console.warn('Monetag SDK not available - simulating');
  }

  adRunning = true;
  let left = REWARD_SECONDS;
  const countdownEl = document.getElementById('ad-countdown');
  const btn = document.getElementById('btn-watch');
  btn.disabled = true; btn.style.opacity = '0.7';
  countdownEl.innerText = `‚è≥ ${left} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶ö‡¶≤‡¶õ‡ßá...`;

  const tick = setInterval(()=>{
    left--;
    if(left > 0){
      countdownEl.innerText = `‚è≥ ${left} ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶ö‡¶≤‡¶õ‡ßá...`;
      return;
    }
    clearInterval(tick);
    adRunning = false;
    btn.disabled = false;
    btn.style.opacity = '1';
    // Reward user
    u.balance = +( (u.balance || 0) + AD_REWARD ).toFixed(2);
    u.adsToday = (u.adsToday || 0) + 1;
    u.adsTotal = (u.adsTotal || 0) + 1;
    u.lastAdDate = todayKey();
    saveState();
    renderHome();

    showBomb();
    showToast(`‚úÖ +${AD_REWARD.toFixed(2)} ‡ß≥ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`, 'success');
    countdownEl.innerText = '‚úÖ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∂‡ßá‡¶∑!';

    // (optional) Notify admin that user watched ad - commented out to avoid spam
    // sendToAdmin(`üì¢ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ:\n‡¶á‡¶â‡¶ú‡¶æ‡¶∞: ${u.id}\n‡¶Ü‡¶ú ‡¶è‡¶°: ${u.adsToday}\n‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ${u.balance.toFixed(2)} ‡ß≥`);
  }, 1000);
}

/* ========== WITHDRAW FLOW ========== */
document.getElementById('submit-withdraw').addEventListener('click', submitWithdraw);

const MIN = { bkash:10, nagad:50, recharge:20 };

function submitWithdraw(){
  if(!joined_channel){ showToast('‚ö†Ô∏è ‡¶Ü‡¶ó‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'error'); openTab('join'); return; }
  const method = document.getElementById('withdraw-method').value;
  const number = document.getElementById('withdraw-number').value.trim();
  const amount = parseFloat(document.getElementById('withdraw-amount').value);

  if(!number || isNaN(amount) || amount <= 0){ showToast('‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ì ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®', 'error'); return; }

  const min = method === 'bkash' ? MIN.bkash : method === 'nagad' ? MIN.nagad : MIN.recharge;
  if(amount < min){ showToast(`‚ö†Ô∏è ${method === 'bkash' ? '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' : method === 'nagad' ? '‡¶®‡¶ó‡¶¶' : '‡¶∞‡¶ø‡¶ö‡¶æ‡¶∞‡ßç‡¶ú'} ‡¶Æ‡¶ø‡¶® ${min}‡ß≥`, 'error'); return; }

  const u = currentUser();
  if(amount > (u.balance || 0)){ showToast('‚ö†Ô∏è ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á', 'error'); return; }

  // Deduct immediately and store pending withdraw
  u.balance = +(u.balance - amount).toFixed(2);
  const req = { id: 'W' + Date.now().toString(36), userId: u.id, method, number, amount, status:'Pending', ts: new Date().toISOString() };
  state.withdraws.push(req);
  saveState();
  renderHome();
  renderHistory();
  renderAdmin();

  // Notify user + admin
  showToast('üì§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá', 'info');

  // Telegram notify admin (may be CORS-blocked in some browsers)
  const adminMessage = `üí≥ ‡¶®‡¶§‡ßÅ‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü\nID: ${req.id}\nUser: ${u.id}\n‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ${method}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ‡ß≥${amount}\n‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: ${number}`;
  sendToAdmin(adminMessage);
}

/* render user's history list (simple) */
function renderHistory(){
  // show on account page or history area (we don't have separate history page here)
  // We'll populate admin + account views; user pending list via account page not implemented separately
  // For simplicity, account shows totals; history table available for admin.
}

/* ========== ADMIN PANEL ========== */
document.getElementById('admin-login-btn').addEventListener('click', adminLogin);

function adminLogin(){
  const pass = document.getElementById('admin-pass').value;
  if(pass !== ADMIN_PASSWORD){ showToast('‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°', 'error'); return; }
  document.getElementById('admin-login-area').classList.add('hidden');
  document.getElementById('admin-area').classList.remove('hidden');
  renderAdmin();
  showToast('‚úÖ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤', 'success');
}

function renderAdmin(){
  const tbody = document.getElementById('admin-users-tbody');
  tbody.innerHTML = '';
  let totalUsers = 0, totalAds = 0, totalBalance = 0;
  Object.values(state.users).forEach(u=>{
    ensureDailyResetForUser(u);
    totalUsers++;
    totalAds += (u.adsTotal || 0);
    totalBalance += Number(u.balance || 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.id}</td><td>${(u.balance||0).toFixed(2)}‡ß≥</td><td>${u.adsToday||0}</td><td>${u.adsTotal||0}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('admin-user-count').innerText = totalUsers;
  document.getElementById('admin-total-ads').innerText = totalAds;
  document.getElementById('admin-total-balance').innerText = totalBalance.toFixed(2);

  // withdraws
  const wt = document.getElementById('admin-withdraws-tbody');
  wt.innerHTML = '';
  state.withdraws.filter(w=> w.status === 'Pending').forEach(w=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td>${w.id}</td><td>${w.userId}</td><td>${w.method}</td><td>${w.number}</td><td>‡ß≥ ${w.amount}</td>
      <td>
        <button onclick="adminApprove('${w.id}')" style="background:#10b981;color:#fff;padding:6px;border-radius:6px">Approve</button>
        <button onclick="adminReject('${w.id}')" style="background:#ef4444;color:#fff;padding:6px;border-radius:6px;margin-left:6px">Reject</but
